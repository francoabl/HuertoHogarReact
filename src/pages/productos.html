<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - HuertoHogar</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/huertohogar-web.css">
    <style>
        .search-filter-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(45, 80, 22, 0.1);
            margin-bottom: 30px;
        }
        
        .search-box .form-control {
            border-radius: 25px 0 0 25px;
            border: 2px solid #e0e0e0;
            padding: 12px 20px;
        }
        
        .search-box .form-control:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.2rem rgba(124, 179, 66, 0.25);
        }
        
        .search-box .btn {
            border-radius: 0;
            border: 2px solid #e0e0e0;
            border-left: none;
            padding: 12px 15px;
        }
        
        .search-box .btn:last-child {
            border-radius: 0 25px 25px 0;
        }
        
        .search-box .btn:hover {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }
        
        .price-filter .form-control {
            border-radius: 25px;
            border: 2px solid #e0e0e0;
            padding: 12px 15px;
        }
        
        .price-filter .form-control:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.2rem rgba(124, 179, 66, 0.25);
        }
        
        .loading {
            display: none;
        }
        
        @media (max-width: 768px) {
            .search-filter-section .row > div {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="huertohogar-web.html">
                <i class="fas fa-seedling me-2"></i>HuertoHogar
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="huertohogar-web.html">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="productos.html">
                            Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="nosotros.html">Nosotros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contacto.html">Contacto</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="blog.html">Blog</a>
                    </li>
                    
                    <!-- Elementos para usuarios no logueados -->
                    <li class="nav-item ms-3 logged-out-only">
                        <a class="btn btn-outline-primary me-2" href="registro.html">
                            <i class="fas fa-user-plus me-2"></i>Registro
                        </a>
                    </li>
                    <li class="nav-item logged-out-only">
                        <a class="btn btn-primary" href="login.html">
                            <i class="fas fa-sign-in-alt me-2"></i>Ingresar
                        </a>
                    </li>
                    
                    <!-- Elementos para usuarios logueados -->
                    <li class="nav-item ms-3 logged-in-only" style="display: none;">
                        <div id="userInfo">
                            <!-- Se llenará dinámicamente con JavaScript -->
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main style="margin-top: 100px; min-height: 80vh;">
        <div class="container">
            <!-- Header -->
            <div class="products-header">
                <h1 class="products-title" id="pageTitle">Nuestros Productos</h1>
                <p class="lead text-muted" id="pageSubtitle">Descubre la frescura del campo chileno</p>
            </div>

            <!-- Search and Filters -->
            <div class="search-filter-section mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="search-box">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Buscar productos...">
                                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="price-filter">
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="precioMin" placeholder="Precio mín." min="0">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" id="precioMax" placeholder="Precio máx." min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Filters -->
            <div class="category-filter">
                <div class="text-center">
                    <h3 class="mb-3">Filtrar por Categoría</h3>
                    <div class="filter-buttons">
                        <button class="btn filter-btn active" data-categoria="todas">Todas</button>
                        <button class="btn filter-btn" data-categoria="frutas frescas">Frutas Frescas</button>
                        <button class="btn filter-btn" data-categoria="verduras">Verduras Orgánicas</button>
                        <button class="btn filter-btn" data-categoria="organicos">Productos Orgánicos</button>
                        <button class="btn filter-btn" data-categoria="lacteos">Productos Lácteos</button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando productos...</span>
                </div>
                <p class="mt-3">Cargando productos frescos...</p>
            </div>

            <!-- Products Grid -->
            <div class="row g-4" id="productsContainer" style="display: none;">
                <!-- Products will be dynamically loaded here -->
            </div>

            <!-- No Products Message -->
            <div class="no-products" id="noProductsMessage" style="display: none;">
                <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                <h3>No se encontraron productos</h3>
                <p>No hay productos disponibles para la categoría seleccionada.</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4">
                    <h3 class="footer-title">
                        <i class="fas fa-seedling me-2"></i>HuertoHogar
                    </h3>
                    <p class="mb-4">Conectando familias chilenas con la frescura del campo desde hace más de 6 años.</p>
                    <div class="d-flex">
                        <a href="#" class="social-icon">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#" class="social-icon">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="#" class="social-icon">
                            <i class="fab fa-twitter"></i>
                        </a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6">
                    <h4 class="footer-title">Navegación</h4>
                    <a href="huertohogar-web.html#inicio" class="footer-link">Inicio</a>
                    <a href="productos.html" class="footer-link">Productos</a>
                    <a href="huertohogar-web.html#nosotros" class="footer-link">Nosotros</a>
                    <a href="huertohogar-web.html#contacto" class="footer-link">Contacto</a>
                </div>
                <div class="col-lg-2 col-md-6">
                    <h4 class="footer-title">Productos</h4>
                    <a href="productos.html?categoria=frutas frescas" class="footer-link">Frutas</a>
                    <a href="productos.html?categoria=verduras" class="footer-link">Verduras</a>
                    <a href="productos.html?categoria=organicos" class="footer-link">Orgánicos</a>
                    <a href="productos.html?categoria=lacteos" class="footer-link">Lácteos</a>
                </div>
                <div class="col-lg-4">
                    <h4 class="footer-title">Contacto</h4>
                    <p><i class="fas fa-envelope me-2"></i>contacto@huertohogar.cl</p>
                    <p><i class="fas fa-phone me-2"></i>+56 2 2345 6789</p>
                    <p><i class="fas fa-map-marker-alt me-2"></i>Santiago, Chile</p>
                </div>
            </div>
            <hr style="border-color: rgba(255,255,255,0.2); margin: 2rem 0 1rem;">
            <div class="text-center">
                <p>&copy; 2024 HuertoHogar. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Message Container for Alerts -->
    <div id="messageContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="../js/components/huertohogar-web.js"></script>
    <script src="../js/auth/auth.js"></script>
    <script src="../js/auth/demo-data.js"></script>
    <script src="../js/cart/cart.js"></script>
    <script>
        // Variables globales
        let productos = [];
        let categoriaActual = 'todas';

        // Datos embebidos como fallback
        const productosEmbebidos = [
            {
                "id": 1,
                "nombre": "Manzanas Rojas",
                "precio": 1200,
                "categoria": "frutas frescas",
                "descripcion": "Manzanas rojas frescas y crujientes, directo del huerto",
                "imagen": "../../public/assets/img/productos/manzanas.webp"
            },
            {
                "id": 2,
                "nombre": "Miel Orgánica",
                "precio": 2500,
                "categoria": "organicos",
                "descripcion": "Miel pura y natural de abejas locales, sin procesamientos químicos",
                "imagen": "../../public/assets/img/productos/miel.webp"
            },
            {
                "id": 3,
                "nombre": "Leche Fresca",
                "precio": 1800,
                "categoria": "lacteos",
                "descripcion": "Leche fresca de vacas locales, rica en nutrientes",
                "imagen": "../../public/assets/img/productos/leche.webp"
            },
            {
                "id": 4,
                "nombre": "Naranjas Dulces",
                "precio": 1100,
                "categoria": "frutas frescas",
                "descripcion": "Naranjas jugosas y dulces, perfectas para jugos naturales",
                "imagen": "../../public/assets/img/productos/naranjas.webp"
            },
            {
                "id": 5,
                "nombre": "Espinacas Orgánicas",
                "precio": 900,
                "categoria": "verduras",
                "descripcion": "Espinacas frescas cultivadas sin pesticidas, ricas en hierro",
                "imagen": "../../public/assets/img/productos/espinacas.webp"
            },
            {
                "id": 6,
                "nombre": "Zanahorias Frescas",
                "precio": 800,
                "categoria": "verduras",
                "descripcion": "Zanahorias frescas y crujientes, perfectas para ensaladas",
                "imagen": "../../public/assets/img/productos/zanahorias.webp"
            }
        ];


        // Mapeo de categorías para los títulos
        const categoriesTitles = {
            'todas': 'Todos Nuestros Productos',
            'frutas frescas': 'Frutas Frescas',
            'verduras': 'Verduras Orgánicas',
            'organicos': 'Productos Orgánicos',
            'lacteos': 'Productos Lácteos'
        };

        // Función para obtener parámetros de la URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Función para cargar productos desde la API
        async function cargarProductos() {
            try {
                console.log('Iniciando carga de productos desde API...');
                
                // Intentar cargar desde la API primero
                try {
                    const response = await fetch('http://localhost:3000/api/products?activo=true');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Datos cargados desde API:', data);
                    
                    if (data.success && data.data && data.data.products) {
                        // Transformar datos de la API al formato esperado por el frontend
                        productos = data.data.products.map(producto => ({
                            id: producto.id,
                            nombre: producto.nombre,
                            precio: producto.precio,
                            categoria: producto.categoria_nombre || 'general',
                            descripcion: producto.descripcion,
                            imagen: producto.imagen ? `http://localhost:3000${producto.imagen}` : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDMwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjUwIiBmaWxsPSIjZjhmZGY0Ii8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEyNSIgcj0iNDAiIGZpbGw9IiM3Y2IzNDIiIG9wYWNpdHk9IjAuMyIvPgo8dGV4dCB4PSIxNTAiIHk9IjEzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD4KPC9zdmc+'
                        }));
                        console.log('Productos transformados:', productos);
                    } else {
                        throw new Error('Formato de respuesta inválido');
                    }
                } catch (fetchError) {
                    console.log('Error al cargar desde API, usando datos embebidos:', fetchError);
                    // Usar datos embebidos como fallback
                    productos = productosEmbebidos;
                    console.log('Usando datos embebidos:', productos);
                }
                
                // Obtener categoría de la URL
                const categoriaUrl = getUrlParameter('categoria');
                if (categoriaUrl && categoriaUrl !== '') {
                    categoriaActual = categoriaUrl;
                    actualizarFiltroActivo(categoriaActual);
                }
                
                mostrarProductos(categoriaActual);
                ocultarLoading();
            } catch (error) {
                console.error('Error crítico al cargar productos:', error);
                mostrarError();
            }
        }

        // Función para mostrar productos filtrados
        function mostrarProductos(categoria) {
            console.log('Mostrando productos para categoría:', categoria);
            console.log('Productos disponibles:', productos);
            
            const container = document.getElementById('productsContainer');
            const noProductsMessage = document.getElementById('noProductsMessage');
            
            // Filtrar productos
            let productosFiltrados;
            if (categoria === 'todas') {
                productosFiltrados = productos;
            } else {
                productosFiltrados = productos.filter(producto => 
                    producto.categoria.toLowerCase() === categoria.toLowerCase()
                );
            }

            console.log('Productos filtrados:', productosFiltrados);

            // Actualizar título
            actualizarTitulo(categoria);

            // Mostrar productos o mensaje de no encontrados
            if (productosFiltrados.length === 0) {
                container.style.display = 'none';
                noProductsMessage.style.display = 'block';
                console.log('No se encontraron productos para la categoría:', categoria);
            } else {
                container.style.display = 'flex';
                noProductsMessage.style.display = 'none';
                
                // Generar HTML de productos
                    container.innerHTML = productosFiltrados.map(producto => `
                        <div class="col-md-6 col-lg-4">
                            <div class="card product-card producto-clickable" data-id="${producto.id}" style="cursor:pointer;">
                                <img src="${producto.imagen}" class="product-image" alt="${producto.nombre}" 
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDMwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjUwIiBmaWxsPSIjZjhmZGY0Ii8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEyNSIgcj0iNDAiIGZpbGw9IiM3Y2IzNDIiIG9wYWNpdHk9IjAuMyIvPgo8dGV4dCB4PSIxNTAiIHk9IjEzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD4KPC9zdmc+'">
                                <div class="card-body">
                                    <h5 class="card-title">${producto.nombre}</h5>
                                    <p class="text-muted small mb-2">${producto.descripcion || 'Producto fresco de calidad premium'}</p>
                                    <p class="text-muted mb-2"><small>Categoría: ${getCategoriaDisplayName(producto.categoria)}</small></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="product-price">$${producto.precio.toLocaleString('es-CL')}</span>
                                        <button class="btn btn-success btn-sm btn-add-to-cart" 
                                                data-id="${producto.id}"
                                                data-nombre="${producto.nombre}"
                                                data-precio="${producto.precio}"
                                                data-imagen="${producto.imagen}"
                                                data-categoria="${producto.categoria}"
                                                onclick="event.preventDefault(); event.stopPropagation(); return false;">
                                            <i class="fas fa-shopping-cart me-1"></i>Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                
                console.log('Productos mostrados correctamente');
            }
        }

        // Función para obtener nombre de categoría para mostrar
        function getCategoriaDisplayName(categoria) {
            const displayNames = {
                'frutas frescas': 'Frutas Frescas',
                'verduras': 'Verduras Orgánicas',
                'organicos': 'Productos Orgánicos',
                'lacteos': 'Productos Lácteos'
            };
            return displayNames[categoria.toLowerCase()] || categoria;
        }

        // Función para actualizar el título de la página
        function actualizarTitulo(categoria) {
            const pageTitle = document.getElementById('pageTitle');
            const pageSubtitle = document.getElementById('pageSubtitle');
            
            pageTitle.textContent = categoriesTitles[categoria] || 'Nuestros Productos';
            
            if (categoria === 'todas') {
                pageSubtitle.textContent = 'Descubre la frescura del campo chileno';
            } else {
                pageSubtitle.textContent = `Los mejores ${getCategoriaDisplayName(categoria).toLowerCase()} directos del campo`;
            }
        }

        // Función para actualizar filtro activo
        function actualizarFiltroActivo(categoria) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[data-categoria="${categoria}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Función para ocultar loading
        function ocultarLoading() {
            document.getElementById('loadingState').style.display = 'none';
        }

        // Función para mostrar error
        function mostrarError() {
            document.getElementById('loadingState').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h3>Error al cargar productos</h3>
                    <p>No se pudieron cargar los productos. Por favor, intenta nuevamente.</p>
                    <button class="btn btn-primary" onclick="location.reload()">Reintentar</button>
                </div>
            `;
        }

        // Variables globales adicionales para filtros
        let busquedaActual = '';
        let precioMinActual = '';
        let precioMaxActual = '';

        // Función para aplicar todos los filtros
        function aplicarFiltros() {
            const filtros = {
                search: busquedaActual,
                categoria: categoriaActual !== 'todas' ? categoriaActual : '',
                precio_min: precioMinActual,
                precio_max: precioMaxActual
            };
            
            mostrarLoading();
            cargarProductosConFiltros(filtros);
        }

        // Función mejorada para cargar productos con filtros
        async function cargarProductosConFiltros(filtros = {}) {
            try {
                console.log('Cargando productos con filtros:', filtros);
                
                // Construir parámetros de consulta
                const params = new URLSearchParams();
                
                if (filtros.search && filtros.search.trim()) {
                    params.append('search', filtros.search.trim());
                }
                
                if (filtros.categoria && filtros.categoria !== 'todas') {
                    // Mapear categorías del frontend a los IDs de la API
                    const categoriaMapping = {
                        'frutas frescas': 1,
                        'verduras': 2,
                        'lacteos': 3,
                        'organicos': 4
                    };
                    const categoriaId = categoriaMapping[filtros.categoria.toLowerCase()];
                    if (categoriaId) {
                        params.append('categoria', categoriaId);
                    }
                }
                
                if (filtros.precio_min && filtros.precio_min > 0) {
                    params.append('precio_min', filtros.precio_min);
                }
                
                if (filtros.precio_max && filtros.precio_max > 0) {
                    params.append('precio_max', filtros.precio_max);
                }
                
                params.append('activo', 'true');
                params.append('limit', '50');
                
                const url = `http://localhost:3000/api/products?${params}`;
                console.log('URL de consulta:', url);
                
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.products) {
                        productos = data.data.products.map(producto => ({
                            id: producto.id,
                            nombre: producto.nombre,
                            precio: producto.precio,
                            categoria: producto.categoria_nombre || 'general',
                            descripcion: producto.descripcion,
                            imagen: producto.imagen || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDMwMCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjUwIiBmaWxsPSIjZjhmZGY0Ii8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEyNSIgcj0iNDAiIGZpbGw9IiM3Y2IzNDIiIG9wYWNpdHk9IjAuMyIvPgo8dGV4dCB4PSIxNTAiIHk9IjEzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD4KPC9zdmc+'
                        }));
                    } else {
                        throw new Error('Formato de respuesta inválido');
                    }
                } catch (fetchError) {
                    console.log('Error al cargar desde API, aplicando filtros a datos embebidos:', fetchError);
                    productos = productosEmbebidos;
                    
                    // Aplicar filtros manualmente
                    if (filtros.search) {
                        productos = productos.filter(p => 
                            p.nombre.toLowerCase().includes(filtros.search.toLowerCase()) ||
                            p.descripcion.toLowerCase().includes(filtros.search.toLowerCase())
                        );
                    }
                    
                    if (filtros.categoria && filtros.categoria !== 'todas') {
                        productos = productos.filter(p => 
                            p.categoria.toLowerCase() === filtros.categoria.toLowerCase()
                        );
                    }
                    
                    if (filtros.precio_min) {
                        productos = productos.filter(p => p.precio >= parseFloat(filtros.precio_min));
                    }
                    
                    if (filtros.precio_max) {
                        productos = productos.filter(p => p.precio <= parseFloat(filtros.precio_max));
                    }
                }
                
                mostrarProductos('todas'); // Mostrar todos los productos filtrados
                ocultarLoading();
            } catch (error) {
                console.error('Error al cargar productos con filtros:', error);
                mostrarError();
            }
        }

        // Función para mostrar loading
        function mostrarLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('productsContainer').style.display = 'none';
            document.getElementById('noProductsMessage').style.display = 'none';
        }

        // Event listeners para filtros
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar productos al cargar la página
            cargarProductos();

            // Event listeners para búsqueda
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const precioMinInput = document.getElementById('precioMin');
            const precioMaxInput = document.getElementById('precioMax');

            // Búsqueda en tiempo real con debounce
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    busquedaActual = this.value;
                    
                    if (busquedaActual.trim()) {
                        clearSearchBtn.style.display = 'block';
                    } else {
                        clearSearchBtn.style.display = 'none';
                    }
                    
                    aplicarFiltros();
                }, 500);
            });

            // Botón de búsqueda
            searchBtn.addEventListener('click', function() {
                busquedaActual = searchInput.value;
                aplicarFiltros();
            });

            // Botón limpiar búsqueda
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                busquedaActual = '';
                this.style.display = 'none';
                aplicarFiltros();
            });

            // Filtros de precio
            let priceTimeout;
            function onPriceChange() {
                clearTimeout(priceTimeout);
                priceTimeout = setTimeout(() => {
                    precioMinActual = precioMinInput.value;
                    precioMaxActual = precioMaxInput.value;
                    aplicarFiltros();
                }, 1000);
            }

            precioMinInput.addEventListener('input', onPriceChange);
            precioMaxInput.addEventListener('input', onPriceChange);

            // Event listeners para botones de categoría (actualizado)
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const categoria = this.getAttribute('data-categoria');
                    categoriaActual = categoria;
                    
                    actualizarFiltroActivo(categoria);
                    aplicarFiltros();
                    
                    const newUrl = categoria === 'todas' ? 'productos.html' : `productos.html?categoria=${encodeURIComponent(categoria)}`;
                    window.history.pushState({categoria: categoria}, '', newUrl);
                });
            });

            // Delegación de evento para productos (sin cambios)
            document.getElementById('productsContainer').addEventListener('click', function(e) {
                if (e.target.closest('.btn-add-to-cart')) {
                    return;
                }
                
                let card = e.target;
                while (card && !card.classList.contains('producto-clickable')) {
                    card = card.parentElement;
                }
                if (card && card.dataset.id) {
                    window.location.href = `detalle-producto.html?id=${card.dataset.id}`;
                }
            });
        });

        // Manejar navegación del navegador (botón atrás/adelante)
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.categoria) {
                categoriaActual = event.state.categoria;
                actualizarFiltroActivo(categoriaActual);
                aplicarFiltros();
            }
        });
    </script>
</body>
</html>
